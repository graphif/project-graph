# 引用块节点精准连线定位功能问题记录

## 问题现象

在实现引用块节点（ReferenceBlockNode）的精准连线定位功能时，应用在启动时出现窗口无法弹出的问题。

## 问题原因

经过分析，问题是由于循环依赖导致的。当我们在以下文件中导入ReferenceBlockNode类时，形成了循环依赖：

1. `ControllerNodeConnection.tsx`
2. `Edge.tsx`
3. `SymmetryCurveEdgeRenderer.tsx`

循环依赖导致应用在启动时无法正确加载模块，从而导致窗口无法弹出。

## 解决方法

1. **移除ReferenceBlockNode的导入语句**：在所有相关文件中移除ReferenceBlockNode的导入语句，避免循环依赖。

2. **使用构造函数名称检查替代直接类型检查**：在需要检查对象是否为ReferenceBlockNode类型的地方，使用`constructor.name === 'ReferenceBlockNode'`来替代直接的`instanceof`检查。

3. **具体修改文件**：
   - `ControllerNodeConnection.tsx`：移除导入，使用构造函数名称检查来记录起始点和结束点的精确位置
   - `Edge.tsx`：移除导入，使用构造函数名称检查来处理引用块节点的精确位置
   - `SymmetryCurveEdgeRenderer.tsx`：移除导入，使用构造函数名称检查来处理引用块节点的法线向量计算

4. **修复后的效果**：应用可以正常启动，窗口能够弹出，同时引用块节点可以实现精准连线定位功能。

## 代码修改示例

```typescript
// 修复前
if (clickedConnectableEntity instanceof ImageNode || clickedConnectableEntity instanceof ReferenceBlockNode) {
  // 处理逻辑
}

// 修复后
if (
  clickedConnectableEntity instanceof ImageNode ||
  clickedConnectableEntity.constructor.name === "ReferenceBlockNode"
) {
  // 处理逻辑
}
```

## 总结

通过移除循环依赖，使用构造函数名称检查替代直接类型检查，我们成功解决了窗口无法弹出的问题，同时实现了引用块节点的精准连线定位功能。这种方法可以避免循环依赖问题，同时保持代码的可读性和可维护性。
